<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unspecified behaviour in std::unordered_set and MacOS SDK | Andrey Nautilus blog</title>
<meta name=keywords content="C++,XCode"><meta name=description content="Never assume unspecified behaviour in C++"><meta name=author content><link rel=canonical href=https://andreynautilus.github.io/posts/2024-12-28-unordered-set-xcode/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://andreynautilus.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andreynautilus.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andreynautilus.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://andreynautilus.github.io/apple-touch-icon.png><link rel=mask-icon href=https://andreynautilus.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://andreynautilus.github.io/posts/2024-12-28-unordered-set-xcode/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=text/javascript>(function(e,t,n,s,o,i,a){e[o]=e[o]||function(){(e[o].a=e[o].a||[]).push(arguments)},e[o].l=1*new Date;for(var r=0;r<document.scripts.length;r++)if(document.scripts[r].src===s)return;i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym"),ym(99367858,"init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0})</script><noscript><div><img src=https://mc.yandex.ru/watch/99367858 style=position:absolute;left:-9999px alt></div></noscript><meta property="og:title" content="Unspecified behaviour in std::unordered_set and MacOS SDK"><meta property="og:description" content="Never assume unspecified behaviour in C++"><meta property="og:type" content="article"><meta property="og:url" content="https://andreynautilus.github.io/posts/2024-12-28-unordered-set-xcode/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-28T16:00:11+01:00"><meta property="article:modified_time" content="2024-12-28T16:00:11+01:00"><meta property="og:site_name" content="Andrey Nautilus blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unspecified behaviour in std::unordered_set and MacOS SDK"><meta name=twitter:description content="Never assume unspecified behaviour in C++"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"posts","item":"https://andreynautilus.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Unspecified behaviour in std::unordered_set and MacOS SDK","item":"https://andreynautilus.github.io/posts/2024-12-28-unordered-set-xcode/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unspecified behaviour in std::unordered_set and MacOS SDK","name":"Unspecified behaviour in std::unordered_set and MacOS SDK","description":"Never assume unspecified behaviour in C++","keywords":["C++","XCode"],"articleBody":"Let’s look at a simple C++ program:\n#include #include void print(const std::unordered_set\u003cint\u003e\u0026 s) { for (const auto\u0026 n : s) { std::cout \u003c\u003c n \u003c\u003c ' '; } std::cout \u003c\u003c std::endl; } int main() { const std::unordered_set\u003cint\u003e s{1, 2, 3, 4, 5}; // construct a set print(s); const std::unordered_set\u003cint\u003e s_1{s}; // copy the set print(s_1); return 0; } What will be the output of this program? Well, it depends on the STL implementation, because it’s unspecified by the standard.\n3 different types of behaviour C++ standard defines 3 types of behaviour:\nundefined behaviour: the standard gives no guarantees, anything can happen. The program may behave differently between different runs; even “your computer may explode”. That’s why it is one of the scariest beasts in C++. unspecified behaviour: the standard delegates the guarantees to the implementation. In this case, the behaviour is defined and the program is predictable, but it may differ per implementation. implementation-defined behavior: same as “unspecified behaviour”, but the implementation must document it. The copy constructor of std::unordered_set doesn’t specify the order of elements in the copy (because it’s unordered set), so every STL implementation may behave differently. It is unspecified behaviour.\nAssumptions are wrong Let’s make an experiment and compile this program with gcc and clang and see the output:\nclang++ -std=c++14 main.cpp -o main \u0026\u0026 ./main g++ -std=c++14 main.cpp -o main \u0026\u0026 ./main I use GodBolt Compiler Explorer for this. The page shows the output for gcc-14.2 and clang-19.1.0 (latest), and gcc-6.5 and clang-5.0.1 (some old versions). In all cases the output is similar: both lines print(s) and print(s_1) produce the same output.\nThis gives us an assumption that copy constructor simply copies the underlying data structure and preserves the order of elements. But this is wrong.\nMacOS Let’s switch to MacOS and XCode. XCode uses a dedicated apple-clang compiler and MacOS SDK provides the STL implementation. Let’s compile and run the same program (tested on XCode-15.0.1 with MacOS SDK 14.0 and XCode-15.3 with MacOS SDK 14.4):\nclang++ -std=c++14 main.cpp -o main \u0026\u0026 ./main 5 4 3 2 1 1 2 3 4 5 Wow, the order of elements has changed. Looking into STL sources we’ll see that copy constructor inserts elements of the original set into the copy:\ntemplate \u003cclass _Value, class _Hash, class _Pred, class _Alloc\u003e unordered_set\u003c_Value, _Hash, _Pred, _Alloc\u003e::unordered_set( const unordered_set\u0026 __u) : __table_(__u.__table_) { _VSTD::__debug_db_insert_c(this); __table_.__rehash_unique(__u.bucket_count()); insert(__u.begin(), __u.end()); } This might explain the change. Let’s extend our program and copy the set a few more times:\nint main() { const std::unordered_set\u003cint\u003e s{1, 2, 3, 4, 5}; // construct a set print(s); const std::unordered_set\u003cint\u003e s_1{s}; // copy the set print(s_1); const std::unordered_set\u003cint\u003e s_2{s_1}; // copy the set print(s_2); const std::unordered_set\u003cint\u003e s_3{s_2}; // copy the set print(s_3); return 0; } Compile and run it:\nclang++ -std=c++14 main.cpp -o main \u0026\u0026 ./main 5 4 3 2 1 1 2 3 4 5 5 4 3 2 1 1 2 3 4 5 The order of elements changes every time the set is copied. And that’s perfectly valid according to the standard, and this proves that the original assumption was wrong.\nConclusion Never assume an unspecified behaviour, even if everything seems reasonable and some experiments prove the assumption. Any change to the setup may break your assumption and thus break the program.\nHistory behind it There was a collection defined as\nstd::vector\u003cstd::unordered_set\u003cint\u003e\u003e unique_ids; This collection was copied multiple times and everything worked fine. Until XCode got updated from 15.0.1 to 15.3. This changed the internal behaviour of std::vector and elements got copied 1 time less, so unordered_sets got copied even amount of times, which changed the resulting order of elements and caused the program to fail. Luckily there was a unittest which started to fail and allowed to debug and find this bug.\n","wordCount":"629","inLanguage":"en","datePublished":"2024-12-28T16:00:11+01:00","dateModified":"2024-12-28T16:00:11+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://andreynautilus.github.io/posts/2024-12-28-unordered-set-xcode/"},"publisher":{"@type":"Organization","name":"Andrey Nautilus blog","logo":{"@type":"ImageObject","url":"https://andreynautilus.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andreynautilus.github.io/ accesskey=h title="Andrey Nautilus blog (Alt + H)"><img src=https://andreynautilus.github.io/apple-touch-icon.png alt aria-label=logo height=35>Andrey Nautilus blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://andreynautilus.github.io/links/ title=links><span>links</span></a></li><li><a href=https://andreynautilus.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://andreynautilus.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://github.com/AndreyNautilus/AndreyNautilus.github.io title=src><span>src</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://andreynautilus.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://andreynautilus.github.io/posts/>posts</a></div><h1 class="post-title entry-hint-parent">Unspecified behaviour in std::unordered_set and MacOS SDK</h1><div class=post-description>Never assume unspecified behaviour in C++</div><div class=post-meta><span title='2024-12-28 16:00:11 +0100 +0100'>December 28, 2024</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>Let&rsquo;s look at a simple C++ program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unordered_set&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&amp;</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>n</span> <span class=p>:</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>n</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39; &#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>};</span>  <span class=c1>// construct a set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s_1</span><span class=p>{</span><span class=n>s</span><span class=p>};</span>  <span class=c1>// copy the set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>What will be the output of this program? Well, it depends on the STL implementation, because it&rsquo;s unspecified by the standard.</p><h2 id=3-different-types-of-behaviour>3 different types of behaviour<a hidden class=anchor aria-hidden=true href=#3-different-types-of-behaviour>#</a></h2><p><a href=https://eel.is/c++draft/>C++ standard</a> defines 3 types of <em>behaviour</em>:</p><ul><li><a href=https://eel.is/c++draft/defns.undefined>undefined behaviour</a>: the standard gives no guarantees, anything can happen.
The program may behave differently between different runs; even &ldquo;your computer may explode&rdquo;.
That&rsquo;s why it is one of the scariest beasts in C++.</li><li><a href=https://eel.is/c++draft/defns.unspecified>unspecified behaviour</a>: the standard delegates the guarantees to the implementation.
In this case, the behaviour is defined and the program is predictable, but it may differ per implementation.</li><li><a href=https://eel.is/c++draft/defns.impl.defined>implementation-defined behavior</a>: same as &ldquo;unspecified behaviour&rdquo;,
but the implementation must document it.</li></ul><p><a href=https://en.cppreference.com/w/cpp/container/unordered_set/unordered_set>The copy constructor</a> of <code>std::unordered_set</code>
doesn&rsquo;t specify the order of elements in the copy (because it&rsquo;s <em>unordered</em> set), so every STL implementation may behave differently.
It is <em>unspecified</em> behaviour.</p><h2 id=assumptions-are-wrong>Assumptions are wrong<a hidden class=anchor aria-hidden=true href=#assumptions-are-wrong>#</a></h2><p>Let&rsquo;s make an experiment and compile this program with <code>gcc</code> and <code>clang</code> and see the output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>clang++ -std<span class=o>=</span>c++14 main.cpp -o main <span class=o>&amp;&amp;</span> ./main
</span></span><span class=line><span class=cl>g++ -std<span class=o>=</span>c++14 main.cpp -o main <span class=o>&amp;&amp;</span> ./main
</span></span></code></pre></div><p>I use <a href=https://godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAMzwBtMA7AQwFtMQByARg9KtQYEAysib0QXACx8BBAKoBnTAAUAHpwAMvAFYTStJg1DIApACYAQuYukl9ZATwDKjdAGFUtAK4sGIM6SuADJ4DJgAcj4ARpjEEgCcpAAOqAqETgwe3r7%2ByanpAiFhkSwxcVyJdpgOGUIETMQEWT5%2BAVU1AnUNBEUR0bEJtvWNzTltwz2hfaUDFQCUtqhexMjsHOYAzKHI3lgA1CYbbk4KBMSYrIfYJhoAgpvbu5gHR14MJFjn6AD6SgRXN3udwAbqg8Og9kliKECBA0AxTntTugQCA3h9Ypgfn9DsdBACzAA2JFzA4Adisdz21L2/GIezhAkRTC8RHMxIYexAJPJlNuNIFSIIKJQSwILzcuL2nNxUrAHD28sOfIFJjJABFAQLkai0KyJVKdSBXLRlYC1Zq7oCYXsWExQhBSWqVTT4YijejiJ8sb9MP8jjCrkjnVxSHsAnsNmHpHsAKwW5V7AD0Sb2brOXgceyYSL9WppUJhEAUczNVqprqZ4o97y9mOxeYD%2BI22CR3y4zoUCY2FmpKbTqCSAE89gQEM8cRXqYXBMX26We%2Bap3tzgRlpyNGX7hqOAtaJxY7w/BwtKRUJxJZZrEilitnpseKQCJpdwsANYgDZkgB0ZLJ8Q0AAODZJA2LgzFjMkNljfROEkI8XzPTheAUEANCfF8FjgWAYCgXCICQTBVGqVkSHISgGmABRlEMTBaCEBBUAAd2PR80BYJI6CYRwBBosJ6MYljEPYzj6DiYApACES6FicJWDWXhpLEgB5VkGOY49TyI6pbmIKjkMCYjkDqfBj14fhBBEMR2CkGRBEUFR1BPHQ9AMIwUGsax9DwKJUMgBZBx4hFOAAWmRQ51VMK9LC4R9UGBWJoSwPzHVIYg3kcNgABVUE8FKFgUW9Vj0ZFQj4uj1KE7heCY4gmCSTgeD3A8EOcpCOGwIzSPpVRAMJELCUkPZgGQZA9ikb8zAZS8rEsMNcEIEgDjMMC5l4Z9nLmd8QFjdD9w4eDSBYEBJFjSbCX/WNAPiXb4kJeIzFDTTeHPDgULQjDNtIbDEGNLqiDICgIEo6jaIEjTGsU1AOK4oLyvBqrTyUgZgEJGDkeIOS2AMjHVOEQTnsMnS9NQt6ieM4VQgMizhFEcRbJphy1EQ3Qozc4xPLm2gfPys8kiC0mwuFCKotmixYpehLiCSzBefSwQ8Gy3LaF5wrlmK0NSoYeHKtYmq6oa6rmo4Q9SEJ17OpIgG9l6/rBuG0a9kJb9Y2mzmbD2BbrYfNbPq0LbSHHJhPkobbdtgg7WtPV73vQjb/eNsxeGO07zsu67bvux6zcQmO/d3b78Pwwj/rIoGQZ1gnIdIJTuIySuIbajGUHZiouHQjGsYUmvodE2I8d1xDtOQXT9LJ4eTKpsmaas%2BnpEZpRmba3QAnZjzopsbnfPgAL%2BYyQXwo2SL3Yls8pZluWMsVzAcrynfFnVmyhlMhuqsfWr6sh43TfNzhLeQbqNs%2BoDSGjsQwwBxrxG/Fwb8Gg3Yb3mvgb2K0uC%2B3jq%2BQOFwQ6pQ/OHfah1jqxkkL%2BDYZgNCSHbpIACGwND/hzm1POqE46YULvAAif0rZlwoiTV%2Bese4wwMHDMGg8m69xknEMBRhdqhk7vJHGYiVJqSrm1Yeo9Sa8AnpTMydlabWQkPPWQTMnKnl0NINeosvJb15oFfeoVD7Hw3qfeKiVwSy3vvLTKN9laqyKk/LWvDq4f0Nk1COP9c5/1Lj1YB9tJEQLOhoaB8CxaIMWvSH261MILCDtgsOe04JRxegZJh%2BcA77STkdHaxCoJkIoeQ6htDEi/zJuggOH5CRmEmmQ%2BIXA0aEkAmSSQRJCQRw2AU9qGTNqJzGXnFpCwpZpGcJIIAA%3D%3D%3D>GodBolt Compiler Explorer</a> for this.
The page shows the output for <code>gcc-14.2</code> and <code>clang-19.1.0</code> (latest), and <code>gcc-6.5</code> and <code>clang-5.0.1</code> (some old versions).
In all cases the output is similar: both lines <code>print(s)</code> and <code>print(s_1)</code> produce the same output.</p><p>This gives us an assumption that copy constructor simply copies the underlying data structure and preserves the order of elements.
But this is wrong.</p><h2 id=macos>MacOS<a hidden class=anchor aria-hidden=true href=#macos>#</a></h2><p>Let&rsquo;s switch to MacOS and XCode. XCode uses a dedicated <code>apple-clang</code> compiler and MacOS SDK provides
the STL implementation. Let&rsquo;s compile and run the same program (tested on XCode-15.0.1 with MacOS SDK 14.0 and XCode-15.3 with MacOS SDK 14.4):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>clang++ -std<span class=o>=</span>c++14 main.cpp -o main <span class=o>&amp;&amp;</span> ./main
</span></span><span class=line><span class=cl><span class=m>5</span> <span class=m>4</span> <span class=m>3</span> <span class=m>2</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> <span class=m>5</span>
</span></span></code></pre></div><p>Wow, the order of elements has changed. Looking into STL sources we&rsquo;ll see that copy constructor <em>inserts</em> elements of the original set
into the copy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>class</span> <span class=nc>_Value</span><span class=p>,</span> <span class=k>class</span> <span class=nc>_Hash</span><span class=p>,</span> <span class=k>class</span> <span class=nc>_Pred</span><span class=p>,</span> <span class=k>class</span> <span class=nc>_Alloc</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>unordered_set</span><span class=o>&lt;</span><span class=n>_Value</span><span class=p>,</span> <span class=n>_Hash</span><span class=p>,</span> <span class=n>_Pred</span><span class=p>,</span> <span class=n>_Alloc</span><span class=o>&gt;::</span><span class=n>unordered_set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>unordered_set</span><span class=o>&amp;</span> <span class=n>__u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>__table_</span><span class=p>(</span><span class=n>__u</span><span class=p>.</span><span class=n>__table_</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_VSTD</span><span class=o>::</span><span class=n>__debug_db_insert_c</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>__table_</span><span class=p>.</span><span class=n>__rehash_unique</span><span class=p>(</span><span class=n>__u</span><span class=p>.</span><span class=n>bucket_count</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>insert</span><span class=p>(</span><span class=n>__u</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>__u</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This might explain the change. Let&rsquo;s extend our program and copy the set a few more times:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>};</span> <span class=c1>// construct a set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s_1</span><span class=p>{</span><span class=n>s</span><span class=p>};</span>  <span class=c1>// copy the set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s_2</span><span class=p>{</span><span class=n>s_1</span><span class=p>};</span>  <span class=c1>// copy the set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s_2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>s_3</span><span class=p>{</span><span class=n>s_2</span><span class=p>};</span>  <span class=c1>// copy the set
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>print</span><span class=p>(</span><span class=n>s_3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Compile and run it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>clang++ -std<span class=o>=</span>c++14 main.cpp -o main <span class=o>&amp;&amp;</span> ./main
</span></span><span class=line><span class=cl><span class=m>5</span> <span class=m>4</span> <span class=m>3</span> <span class=m>2</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=m>5</span> <span class=m>4</span> <span class=m>3</span> <span class=m>2</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> <span class=m>5</span>
</span></span></code></pre></div><p>The order of elements changes every time the set is copied. And that&rsquo;s perfectly valid according to the standard,
and this proves that <strong>the original assumption was wrong</strong>.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Never assume an unspecified behaviour, even if everything seems reasonable and <em>some</em> experiments prove the assumption.
Any change to the setup may break your assumption and thus break the program.</p><h3 id=history-behind-it>History behind it<a hidden class=anchor aria-hidden=true href=#history-behind-it>#</a></h3><p>There was a collection defined as</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;</span> <span class=n>unique_ids</span><span class=p>;</span>
</span></span></code></pre></div><p>This collection was copied multiple times and everything worked fine. Until XCode got updated from 15.0.1 to 15.3.
This changed the internal behaviour of <code>std::vector</code> and elements got copied 1 time less,
so <code>unordered_set</code>s got copied even amount of times, which changed the resulting order of elements and caused the program to fail.
Luckily there was a unittest which started to fail and allowed to debug and find this bug.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andreynautilus.github.io/tags/c++/>C++</a></li><li><a href=https://andreynautilus.github.io/tags/xcode/>XCode</a></li></ul><nav class=paginav><a class=next href=https://andreynautilus.github.io/posts/2024-12-24-gitignore-global/><span class=title>Next »</span><br><span>Global .gitignore</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://andreynautilus.github.io/>Andrey Nautilus blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>