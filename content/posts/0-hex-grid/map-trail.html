<div style="text-align: center;">
<canvas id="map-trail" width="600" height="400"></canvas>
<script type="module">

function generateTrailEnds(grid) {
    const border = 0.25;

    //const start = randomIntPoint(grid.rows_count, Math.ceil(grid.cols_count * border));
    const start = new Point(randomInt(grid.rows_count), 0);
    const end = new Point(randomInt(grid.rows_count), grid.cols_count - 1);

    // let end = randomIntPoint(grid.rows_count, Math.ceil(grid.cols_count * border));
    // end = {row: end.row, col: end.col + Math.floor(grid.cols_count * (1 - border))};

    return [start, end];
}

function findPath(grid, start, end) {
    let path = [start];

    // breadth-first pathfinding
    let queue = [start];
    let visited = new Set();
    let cameFrom = new Map();

    visited.add(`${start.row},${start.col}`);

    while (queue.length > 0) {
        let current = queue.shift();

        if (current.row === end.row && current.col === end.col) {
            // Reconstruct path
            let path = [];
            while (current) {
                path.unshift(current);
                current = cameFrom.get(`${current.row},${current.col}`);
            }
            return path;
        }

        for (let neighbor of grid.getNeighbors(current).filter(p => grid.cell(p) !== undefined)) {
            const neighborKey = `${neighbor.row},${neighbor.col}`;
            if (!visited.has(neighborKey)) {
                visited.add(neighborKey);
                cameFrom.set(neighborKey, current);
                queue.push(neighbor);
            }
        }
    }

    return []; // Return empty path if no path is found
}

function count(grid, value) {
    let count = 0;
    for (let row_idx = 0; row_idx < grid.rows_count; ++row_idx) {
        for (let col_idx = 0; col_idx < grid.cols_count; ++col_idx) {
            if (grid.getCell({row: row_idx, col: col_idx}) === value) {
                count++;
            }
        }
    }
    return count;
}

function generateMap_trail(grid) {
    const trailEnds = generateTrailEnds(grid);

    grid.fill(ColorGreyIdx);

    let queue = [];
    for (let row_idx = 0; row_idx < grid.rows_count; ++row_idx) {
        for (let col_idx = 0; col_idx < grid.cols_count; ++col_idx) {
            const p = new Point(row_idx, col_idx);
            if (!p.equals(trailEnds[0]) && !p.equals(trailEnds[1])) {
                queue.push(p);
            }
        }
    }

    let path = findPath(grid, trailEnds[0], trailEnds[1]);

    const maxAmount = Math.floor(grid.rows_count * grid.cols_count * 0.5);
    while (queue.length > maxAmount) {
        const cellIdx = randomInt(queue.length);
        const cell = queue[cellIdx];

        if (path.find(p => cell.equals(p)) !== undefined) {
            queue.splice(cellIdx, 1);
            grid.setCell(cell, undefined);

            let newPath = findPath(grid, trailEnds[0], trailEnds[1]);
            if (newPath.length === 0) {
                // no new path => return the cell back to grid and queue
                queue.push(cell);
                grid.setCell(cell, ColorGreyIdx);
            } else {
                path = newPath;
            }
        } else {
            queue.splice(cellIdx, 1);
            grid.setCell(cell, undefined);
        }
    }

    grid.fill(undefined);

    path.forEach(cell => {
        grid.setCell(cell, ColorPurpleIdx);
    });

    return trailEnds;
}

function generateAndRenderMap_trail() {
    const canvas = document.getElementById("map-trail");

    const cell_radius = 10;
    const cell_diameter = 2 * cell_radius;

    // construct grid
    const cols_count = Math.floor((canvas.width - cell_radius) / cell_diameter);
    const rows_count = Math.floor(canvas.height / cell_diameter);
    let grid = new HexGrid(rows_count, cols_count);

    // generate random map
    const initialPoints = generateMap_trail(grid);

    // draw map
    renderGrid(canvas, grid, initialPoints, colors, cell_radius);
}

document.getElementById("map-trail").addEventListener('click', generateAndRenderMap_trail);
generateAndRenderMap_trail();

</script>
</div>
